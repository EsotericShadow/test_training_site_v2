# Karma Training Website - Codebase Documentation

This document provides a detailed overview of the `karma-training-website` project, intended to supplement the existing codebase with high-level explanations of its structure, key components, and operational scripts.

## 1. Project Structure and Configuration

This section outlines the purpose of key directories and configuration files in the project root.

### 1.1. Core Directories

-   **`.next/`**: The output directory for the Next.js build. It contains compiled code, static assets, and server-side bundles required to run the application.
-   **`lib/`**: A crucial directory containing shared modules and utility functions that support the entire application. This includes database operations, security features, session management, and logging.
-   **`public/`**: Stores static assets that are publicly accessible and served directly by Next.js, such as images, fonts, and the `robots.txt` file.
-   **`scripts/`**: Contains Node.js scripts for database management, data seeding, and other maintenance tasks.
    -   **`migrations/`**: This subdirectory holds all the individual database migration files. Each file is timestamped and contains `up` and `down` functions to apply or revert schema changes.
-   **`src/`**: The main source code directory for the Next.js application.
    -   **`src/app/`**: The core of the application, following the Next.js App Router structure. It contains pages, API routes, and reusable components.
        -   **`api/`**: Holds all backend API route handlers, which are responsible for processing requests, interacting with the database, and returning data to the client.
        -   **`adm_f7f8556683f1cdc65391d8d2_8e91/`**: Contains all pages and components related to the admin panel. The obscure name is a security measure to make it harder for unauthorized users to find the admin login page.
        -   **`components/`**: A library of reusable React components used throughout the application, organized by feature (e.g., `home`, `layout`, `forms`).

### 1.2. Configuration Files

-   **`.eslintrc.json` & `eslint.config.mjs`**: Configuration files for ESLint, a tool for identifying and reporting on patterns found in ECMAScript/JavaScript code.
-   **`.gitignore`**: A file that specifies which files and directories should be ignored by Git.
-   **`jest.config.js` & `jest.setup.js`**: Configuration files for Jest, the testing framework used for unit and integration tests.
-   **`next.config.ts`**: The main configuration file for Next.js. It controls settings such as build optimizations, image handling, and security headers.
-   **`next-sitemap.config.js`**: Configuration for the `next-sitemap` package, which is used to automatically generate a `sitemap.xml` file for SEO purposes.
-   **`package.json`**: Defines project metadata, lists all dependencies, and contains scripts for running, testing, and building the application.
-   **`pnpm-lock.yaml`**: The lockfile generated by the `pnpm` package manager, ensuring consistent dependency installation across different environments.
-   **`postcss.config.mjs`**: Configuration for PostCSS, a tool for transforming CSS with JavaScript plugins. It's used here with Tailwind CSS.
-   **`tailwind.config.ts`**: The configuration file for Tailwind CSS, a utility-first CSS framework used for styling the application.
-   **`tsconfig.json`**: The configuration file for TypeScript, specifying the root files and the compiler options required to compile the project.

### 1.3. Key Files

-   **`src/middleware.ts`**: This file contains the Next.js middleware, which runs before a request is completed. It is used to enforce security policies, such as checking for a valid admin session on protected routes and redirecting unauthenticated users to the login page.

## 2. `lib/` Directory: Core Functionality

The `lib/` directory is the heart of the application's backend logic, providing a suite of modules for handling common tasks.

-   **`account-security.js`**: Implements account security features, including brute-force protection and account lockout mechanisms.
    -   **Key Functions**: `checkAccountLockout`, `recordFailedLoginAttempt`, `resetFailedLoginAttempts`.
-   **`csrf.js`**: Provides functions for generating and validating CSRF (Cross-Site Request Forgery) tokens, which are used to protect against CSRF attacks on the admin panel.
    -   **Key Functions**: `generateToken`, `validateToken`.
-   **`database.js`**: Centralizes all database interactions. It exports a collection of "operation objects" (e.g., `coursesOps`, `teamMembersOps`) that provide a clean API for performing CRUD (Create, Read, Update, Delete) operations on each database table.
-   **`lib-utils.ts`**: Contains general-purpose utility functions used across the application, such as formatting class names, prices, and durations.
-   **`logger.js`**: Implements a structured logging system with different severity levels (ERROR, WARN, INFO, DEBUG). It logs important events, errors, and security-related information.
-   **`rate-limiter.js`**: Provides a robust rate-limiting system to protect API endpoints from abuse and denial-of-service attacks. It defines different rules for various actions (e.g., login, contact form submission).
-   **`secure-jwt.js`**: Manages the creation, verification, and secure authentication of JSON Web Tokens (JWTs) for admin sessions. It includes advanced security features like IP binding and device fingerprinting to prevent session hijacking.
    -   **Key Functions**: `generateSecureToken`, `verifySecureToken`, `authenticateSecure`, `withSecureAuth`.
-   **`security-utils.js`**: A collection of general security utilities, including functions for sanitizing and validating user input to prevent XSS (Cross-Site Scripting) and other injection attacks.
-   **`session-manager.js`**: Manages user sessions by integrating the secure JWTs from `secure-jwt.js` with database operations. It handles session creation, validation, renewal, and termination.

## 3. `scripts/` Directory: Automation and Maintenance

The `scripts/` directory contains essential scripts for managing the application's database and content.

-   **`migrate.js`**: A command-line interface for managing database migrations. It allows developers to apply new schema changes, roll back to a previous version, and check the status of all migrations.
    -   **Usage**:
        -   `node scripts/migrate.js up`: Applies all pending migrations from the `scripts/migrations/` directory.
        -   `node scripts/migrate.js down`: Reverts the most recently applied migration.
        -   `node scripts/migrate.js status`: Displays the status of each migration (applied or pending).
-   **`seed-content.js`**: A script to populate the database with a complete set of initial content. This is particularly useful for setting up a new development environment or for demonstration purposes. It seeds data for company information, courses, team members, and more.
    -   **Usage**: `node scripts/seed-content.js`
-   **`seed-default-admin-users.js`**: A script to create the default 'admin' and 'webmaster' users. The credentials for these users are sourced from environment variables, providing a secure way to initialize the first admin accounts.
    -   **Usage**: `node scripts/seed-default-admin-users.js`
